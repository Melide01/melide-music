<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melide</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');

        @font-face {
          font-family: 'MelideSerif';
          src: url("/assets/incomplete-MelideSansSerif.ttf") format("truetype");
        }

        :root {
            --margin: .5em;
            --gap: 1em;

            --color-dark: #111;
            --color-light: #EFEFFE;
            --color-accent: #2C7;
        }

        html {
            background-color: #111;
        }

        html, body {
            font-family: Arial, Helvetica, sans-serif;
            width: 100%;
            height: 100%;
        }

        * {
            font-family: "Montserrat", Arial, Helvetica, sans-serif;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        section {
            gap: var(--gap);
            max-width: 500px;
            width: 100%;
            padding: var(--gap);
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .title_card {
            position: relative;
            overflow: hidden;
            border-radius: calc(var(--gap) + var(--margin));
            text-shadow: -.7px -.7px 0 #7779, -.7px .7px 0 #7779, .7px -.7px 0 #7779, .7px .7px 0 #7779, 0 0 3px #111;
            color: var(--color-light);
            border: 2px solid #1119;
            outline: 1px solid #EEE3;
            padding: var(--margin);
            width: 100%;
        }
        .title_card::before {
            content: "";
            position: absolute;
            width: calc(100% + 10em);
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            animation: glint_patrol 9999ms infinite ease-in-out, glint_blink 5555ms infinite ease-in-out;
            background: linear-gradient(to right, #0000 10%, #777 50%, #0000 90%);
        }
        .title_card::after {
            content: "";
            position: absolute;
            width: calc(100% + 10em);
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            animation: glint_patrol 7777ms infinite ease-in-out, glint_blink 3333ms infinite ease-in-out;
            background: linear-gradient(to right, #0000 10%, #557 50%, #0000 90%);
        }
        @keyframes glint_blink {
            0%, 100% { opacity: .2;}
            50% {opacity: 1;}
            
        }
        @keyframes glint_patrol {
            0%, 100% {
                left: 0em;
            }
            50% {
                left: -10em;
            }
        }

        #lyrics_holder {
            color: #FFFA;
            transition: color 500ms;
        }

        #lyrics_holder:hover {
            cursor: default;
            color: #FFF;
        }

        #lyrics_holder::-webkit-scrollbar {
            display: none;
        }

        img.track_icon {
            width: 100%;
            cursor: pointer;
            border-radius: calc(var(--gap));
            mix-blend-mode:overlay;
            transition: opacity 200ms;
        }
        img.track_icon:hover {
            mix-blend-mode:exclusion;
            opacity: .3;
        }

        .listen {
            cursor: pointer;
            color: #FFF;
            text-decoration: none;
            width: 4em;
            height: 2em;
            aspect-ratio: 1 / 1;
            background: linear-gradient(to top, #0000, var(--fa-color) 60%);
            background-size: 120% 120%; background-position: center;
            border: .1em solid #1110;
            border-radius: 50em;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: border 200ms, color 400ms, width 200ms ease-out, transform 100ms, padding 100ms, height 300ms;
        }

        .listen.large {
            width: 100%;
            height: 1.45em;
        }

        .listen:not(.large):hover, .listen:not(.large):focus {
            aspect-ratio: unset;
            width: 5em;
            border-color: #111;
            color: #111;
        }

        .listen.large:hover, .listen.large:focus {
            padding-top: .2em;
        }

        .listen:active, .listen:focus {
            transform: translateY(.25em);
        }

        .loading {
            position: fixed;
            z-index: 9;
            background-color: #111;
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            transition: opacity 500ms, transform 1000ms;
        }
        .loading > div {
            height: auto;
            aspect-ratio: 1/1;
            opacity: 0;
            animation: wing_rotate 9999ms infinite linear, wing_reveal 3s forwards ease-out .5s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading.hide {
            opacity: 0;
            transform: scale(200%);
            pointer-events: none;
        }

        .loading img {
            height: 7em;
            position: absolute;
            transform: rotate(var(--deg)) translateY(1em);
            animation: wing_loading 4444ms infinite ease-in-out, wing_blink 2222ms infinite linear var(--delay);
        }
        .loading img:nth-child(1) {
            --deg: 0;
            --delay: calc(2222ms / 3 * 1);
        }
        .loading img:nth-child(2) {
            --deg: 120deg;
            --delay: calc(2222ms / 3 * 2);
        }
        .loading img:nth-child(3) {
            --deg: 240deg;
            --delay: calc(2222ms);
        }
        @keyframes wing_rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes wing_loading {
            0%, 100% { transform: rotate(var(--deg)) translateY(1em); }
            50% { transform: rotate(var(--deg)) translateY(-3em); }
        }
        @keyframes wing_blink {
            0%, 40%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }
        @keyframes wing_reveal {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        #title {
            opacity: .5;
            display: flex;
            flex-direction: row;
            color: #FFF;
            font-size: 2em;
            cursor: pointer;
            transition: font-size 1000ms ease-in-out, opacity 100ms;
        }
        
        #title>h1 {
            font-family: 'MelideSerif';
        }

        #title:hover {
            opacity: 1;
        }

        #logo_loaded {
            opacity: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: unset;
            height: 5em;
        }

        @keyframes loaded_appear {
            50% {
                opacity: 1;
                height: 7em;
            }
            to {
                opacity: .5;
                height: 5em;
            }
        }
    </style>
    <script src="https://kit.fontawesome.com/22e9bcee35.js" crossorigin="anonymous"></script>
    
</head>
<body>
    <div id="loading_pannel" class="loading">
        <img id="logo_loaded" src="/assets/mld_logo_all_white.png">
        <div>
            <img class="wing_1" src="assets/mld_logo_bottom_white.png">
            <img class="wing_2" src="assets/mld_logo_bottom_white.png">
            <img class="wing_3" src="assets/mld_logo_bottom_white.png">
        </div>
        
    </div>

    <section style="border-top: 1em solid var(--color-accent);;">
        <div id="title" onclick="location.href = '/home'">
            <img src="assets/mld_logo_all_white.png" style="height: 2em; margin-bottom: 1em;">
            <h1 style="font-weight: 100; font-size: 1.75em;">Melide</h1>
        </div>
        <h5 style="color: #555; width: 100%;">Derni√®re sortie</h5>
        <div class="title_card">
            <div id="latest_song_card" style="display: grid; grid-template-columns: 40% auto; align-items: center;">
                <img class="track_icon" src="assets/placeholder.webp">
                <div style="padding: var(--gap); display: flex; flex-direction: column; justify-content: center;">
                    <h1 style="font-size: 3em; font-weight: 200;">Title</h1>
                    <h3 style="margin-bottom: 1em; font-size: 1em; font-weight: 100;">Author</h3>
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <a id="spotify_link" style="font-size: 2.5em; --fa-color: #2C5" class="listen spotify"><i class="fa-solid fa-play"></i></a>
                    </div>
                </div>
                <div style="grid-column: 1/3; display: flex; flex-direction: column; align-items: center; gap: .5em; font-size: .7em;">
                    <br><br>
                    <h5>Lyrics</h5>
                    <div id="lyrics_holder" style="overflow: auto; width: 100%; font-size: 2.5em; height: 10em; font-weight: 100;"></div>
                    <br>
                    <a id="youtube_link" style="font-size: 2.5em; --fa-color: #5675" class="listen large spotify"><i class="fa-brands fa-youtube"></i></a>
                    <a id="soundcloud_link" style="font-size: 2.5em; --fa-color: #5675" class="listen large spotify"><i class="fa-brands fa-soundcloud"></i></a>
                    <a id="deezer_link" style="font-size: 2.5em; --fa-color: #5675" class="listen large spotify"><i class="fa-brands fa-deezer"></i></a>
                </div>
            </div>
        </div>

        <div class="title_card">
            <div style="display: flex; width: 100%; flex-direction: row; justify-content: center; font-size: 1.3em; gap: 1em;">
                <a class="listen spotify" style="--fa-color: #ee2a7b" href="https://www.instagram.com/le.melide/"><i class="fa-brands fa-instagram"></i></a>
                <a class="listen spotify" style="--fa-color: #5675" href="https://www.youtube.com/@LeMelide"><i class="fa-brands fa-youtube"></i></a>
                <a class="listen spotify" style="--fa-color: #5675" href="https://open.spotify.com/intl-fr/artist/6cQGzAGyhQlCR53kF5n8j8"><i class="fa-brands fa-spotify"></i></a>
            </div>
            
        </div>

        <footer style="color: #777; margin-top: 5em;">
            <p>@Melide 2025</p>
        </footer>
    </section>

    <script>
        const youtube_link = document.getElementById('youtube_link');
        const soundcloud_link = document.getElementById('soundcloud_link');
        const deezer_link = document.getElementById('deezer_link');
        const spotify_link = document.getElementById('spotify_link');
        const lyrics_holder = document.getElementById('lyrics_holder');

        const loading_pannel = document.getElementById('loading_pannel');
        const latest_song_card = document.getElementById('latest_song_card');
        var fetchable_google_sheet = "https://script.google.com/macros/s/AKfycbxUxJcHeYWkjr72cOEcu-IU91rOWLv6kX-Vtb8BK0eGPJpiwGK51S6EaEQOy3C99hSvyA/exec";
        
        var cached_tracks;
        const title_el = document.getElementById('title');
        const logo_loaded = document.getElementById('logo_loaded');

        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem("tracks")) {
                cached_tracks = JSON.parse(sessionStorage.getItem("tracks"));

                setTimeout(() => {    
                    load_latest_song();    
                }, 1000);
                
            } else {
                console.log(cached_tracks);
                fetch(fetchable_google_sheet + "?get=tracks")
                    .then(res => res.json())
                    .then(data => {
                        sessionStorage.setItem("tracks", JSON.stringify(data));
                        cached_tracks = data;
                        load_latest_song();
                    })
                    .catch(err => console.error(err));
            }
        });

        function load_latest_song() {
            logo_loaded.style.animation = "loaded_appear 500ms forwards";

            loading_pannel.classList.add('hide');
            const latest_release = Object.fromEntries(cached_tracks.tracks_data.filter(v => v[3] === "Released" && v[6] === "Song").sort((a, b) => new Date(b[4]) - new Date(a[4]))[0].map((v, i) => [String(cached_tracks.tracks_data[0][i]).toLocaleLowerCase().replaceAll(' ', '_'), v]))
            latest_song_card.querySelector('img').src = "https://drive.google.com/thumbnail?sz=w1920&id=" + latest_release.cover_art;
            
            let contents = Object.fromEntries(latest_release.content.split(/[\/]{2}\s+(.+?)[\/]{2}/g).filter(v => v && v !== "\\n").map(v => v.split(/^(.+?)\\n/).filter(v => v)));
            lyrics_holder.innerHTML = contents.Paroles.replaceAll('\\n', '\n').replaceAll(/[\*|(]+(.+)[\*|)]+/g, '').replaceAll('\n', '<br>');
            
            latest_song_card.querySelector('h1').textContent = latest_release.track_name;
            latest_song_card.querySelector('h3').textContent = latest_release.track_artists !== "Melide" ? latest_release.track_artists : "";
            if (!latest_release.youtube_link) youtube_link.style.display = "none";
            if (!latest_release.soundcloud_link) soundcloud_link.style.display = "none";
            if (!latest_release.deezer_link) deezer_link.style.display = "none";
            if (!latest_release.spotify_link) spotify_link.style.display = "none";
            youtube_link.href = latest_release.youtube_link;
            soundcloud_link.href = latest_release.soundcloud_link;
            deezer_link.href = latest_release.deezer_link;
            spotify_link.href = latest_release.spotify_link;

            setTimeout(() => {
                title_el.style.fontSize = "1em";
            }, 2000);
        }
        
        
    </script>
</body>
</html>